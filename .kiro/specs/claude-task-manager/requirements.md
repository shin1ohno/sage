# 要件文書

## はじめに

sage（賢者）は、Claude DesktopとClaude Code向けのMCPサーバーとして実装されるAIアシスタントです。タスク管理、優先順位付け、リマインド設定、カレンダー統合を自動化します。システムは個人の作業パターンを学習し、パーソナライズされたタスク整理とスケジューリング推奨を提供します。

このプラグインは最初にMercariのエンジニア（個人貢献者およびエンジニアリングマネージャー）をターゲットとし、将来的には全社展開を計画しています。Apple Reminders（AppleScript経由）、Notion（MCP経由）、カレンダー（AppleScript経由）と統合し、macOS環境でシームレスなタスク管理を提供します。

## プラットフォーム対応状況

| プラットフォーム | 状態 | 備考 |
|----------------|------|------|
| Desktop MCP (macOS) | ✅ 実装済み | AppleScript、ファイルシステム、Notion MCP |
| iOS/iPadOS | ✅ **Remote MCP対応** | Remote MCPサーバー経由で完全機能 |
| Web | ✅ **Remote MCP対応** | Remote MCPサーバー経由で完全機能 |

> **Remote MCP対応**: iOS/iPadOSとWebブラウザからClaude.aiを使用する際、Remote MCPサーバー経由でデスクトップ版と同等の完全機能にアクセス可能です。ネイティブSkills統合は不要となりました。

## 要件

### 要件1: 初期セットアップと設定

**ユーザーストーリー:** 新規ユーザーとして、3分以内に初期セットアップを完了したい。複雑な設定なしにすぐにAIアシスタントを使い始められるようにするため。

#### 受け入れ基準

1. ユーザーが初回プラグインを起動したとき、システムは設定ファイルの存在を確認すること
2. 設定ファイルが存在しない場合、システムはセットアップが必要であることを表示すること
3. ユーザーがセットアップウィザードを開始したとき、システムは最大10問の質問を提示すること
4. ユーザーがすべてのセットアップ質問を完了したとき、システムは30秒以内に設定ファイルを生成すること
5. 設定が保存されたとき、システムは~/.sage/config.jsonに保存すること
6. セットアップが完了したとき、システムはユーザーに設定成功を確認すること

### 要件2: タスク分析と優先順位付け

**ユーザーストーリー:** 忙しいエンジニアとして、システムに自動的にタスクを分析して優先順位を割り当ててもらいたい。最も重要な作業に最初に集中できるようにするため。

#### 受け入れ基準

1. ユーザーがタスクリストを提供したとき、システムは各タスクの優先度レベルを分析すること
2. 優先度を分析するとき、システムは設定されたルールに基づいてP0、P1、P2、P3を割り当てること
3. タスクに期限キーワードが含まれているとき、システムは緊急度に基づいて優先順位を付けること
4. タスクにユーザーのマネージャーが言及されているとき、システムはより高い優先度を考慮すること
5. 優先度が決定されたとき、システムは割り当ての理由を提供すること
6. タスクが分析されたとき、システムは完了時間を分単位で見積もること

### 要件3: 時間見積もりとスケジューリング

**ユーザーストーリー:** ユーザーとして、システムにタスクの所要時間を見積もってもらい、いつ実行するかを提案してもらいたい。効果的に一日を計画できるようにするため。

#### 受け入れ基準

1. タスクを分析するとき、システムはキーワードに基づいて完了時間を見積もること
2. 時間を見積もるとき、システムは設定された時間マッピング（簡単：25分、複雑：75分など）を使用すること
3. 利用可能な時間枠を見つけるとき、システムはユーザーのカレンダーを確認すること
4. カレンダーを確認するとき、システムは設定された勤務時間を尊重すること
5. 時間枠を提案するとき、システムは深い作業日と会議の多い日を考慮すること
6. 競合がない場合、システムは理由付きで最適な時間枠を提案すること

### 要件4: 関係者の識別

**ユーザーストーリー:** チームメンバーとして、システムにタスクに関わる他の人を識別してもらいたい。適切な人と効果的に連携できるようにするため。

#### 受け入れ基準

1. タスクを分析するとき、システムはタスク内容から関係者名を抽出すること
2. 関係者を抽出するとき、システムは設定されたチームメンバーを認識すること
3. @メンションを見つけたとき、システムはそれらを関係者として含めること
4. マネージャーキーワードが検出されたとき、システムはマネージャーの関与をフラグ付けすること
5. 関係者が識別されたとき、システムは関連する人のリストを返すこと

### 要件5: リマインド管理

**ユーザーストーリー:** 忘れっぽい人として、システムにタスクの適切なリマインドを設定してもらいたい。重要な期限を逃さないようにするため。

#### 受け入れ基準

1. タスクに期限があるとき、システムは適切なリマインド時間を提案すること
2. 期限が7日以内のとき、システムはApple Remindersを作成すること
3. 期限が8日以上先のとき、システムはNotionエントリを作成すること
4. **期限が設定されていないとき、システムはNotionエントリを作成すること（無限の未来と仮定）**
5. リマインドを設定するとき、システムは設定されたリマインド設定を使用すること
6. リマインドが作成されたとき、システムは作成成功を確認すること
7. リマインド作成が失敗したとき、システムはエラー詳細を提供すること

### 要件6: カレンダー統合

**ユーザーストーリー:** カレンダーに依存する作業者として、システムに私のスケジュールを理解してもらい、現実的な時間枠を提案してもらいたい。既存のコミットメントの周りでタスクを計画できるようにするため。

#### 受け入れ基準

1. 空き状況を確認するとき、システムは利用可能なカレンダー統合方法を検出すること
2. macOSで動作するとき、システムはAppleScript経由でCalendar.appから情報を取得すること
3. カレンダーを分析するとき、システムは空いている時間枠を識別すること
4. 時間枠を評価するとき、システムは設定された深い作業日を考慮すること
5. 会議の多い日が設定されているとき、システムはそれらの枠をあまり適さないとマークすること
6. 競合が検出されたとき、システムはその時間帯を除外すること
7. 枠を提案するとき、システムは適合性でランク付けし、使用したカレンダー統合方法を明記すること
8. カレンダーアクセスが利用できない場合、システムは手動入力プロンプトを提供すること

### 要件7: クロスプラットフォーム互換性

**ユーザーストーリー:** Claude DesktopとClaude Codeの両方のユーザーとして、両方の環境で同じ機能を使いたい。どちらのツールを使っていても一貫したタスク管理ができるようにするため。

#### 受け入れ基準

1. MCPサーバーとしてデプロイされたとき、システムはClaude Desktopで動作すること
2. MCPサーバーとしてデプロイされたとき、システムはClaude Codeで動作すること
3. どちらのMCPクライアントを使用しても、システムは同一の機能を提供すること
4. 設定ファイルが存在するとき、両方のMCPクライアントは同じ設定ファイル（~/.sage/config.json）を使用すること
5. ツールが呼び出されたとき、両方のMCPクライアントは同じ結果を返すこと
6. iOS/iPadOS/Webからの接続時、Remote MCPサーバー経由で同等の機能を提供すること

### 要件8: Notion統合

**ユーザーストーリー:** Notionユーザーとして、長期タスクを自動的にNotionデータベースに同期してもらいたい。好みのツールでプロジェクトを管理できるようにするため。

#### 受け入れ基準

1. タスクの期限が8日以上先、または期限が設定されていないとき、システムはNotion MCP Server経由でNotionに同期すること
2. Notionに同期するとき、システムは設定されたデータベースIDを使用すること
3. Notionページを作成するとき、システムはタイトル、優先度、期限、関係者を含めること
4. 同期が成功したとき、システムはNotionページURLを返すこと
5. MCP通信が失敗したとき、システムはエラー詳細と手動コピー用テキストを提供すること

> **注意**: Notion統合にはNotion MCP Serverが事前に設定されている必要があります。
> **注意**: 期限が設定されていないタスクは「無限の未来」と仮定し、長期タスクとしてNotionで管理されます。

### 要件9: Apple Reminders統合

**ユーザーストーリー:** Appleエコシステムユーザーとして、短期タスクをApple Remindersに追加してもらいたい。すべてのデバイスでネイティブ通知を受け取れるようにするため。

#### 受け入れ基準

1. タスクの期限が7日以内のとき、システムはApple Remindersを作成すること
2. macOSで動作するとき、システムはAppleScript統合を使用すること
3. リマインダーを作成するとき、システムは設定されたリマインダーリストを使用すること
4. リマインダーが作成されたとき、システムは適切な期限日とアラームを設定すること
5. 作成が失敗したとき、システムはエラー詳細と使用した統合方法を提供すること
6. AppleScript統合が利用できない場合、システムは手動コピー用テキストを生成すること

> **注意**: iOS/iPadOS/WebからはRemote MCPサーバー経由でApple Reminders統合を利用できます。

### 要件10: 設定管理

**ユーザーストーリー:** 変化する設定を持つユーザーとして、設定を更新したい。システムが進化する作業パターンに適応できるようにするため。

#### 受け入れ基準

1. 設定の更新が必要なとき、システムは部分更新を許可すること
2. カレンダー設定を更新するとき、システムは勤務時間形式を検証すること
3. 優先度ルールを更新するとき、システムはルール構文を検証すること
4. 統合を更新するとき、システムはAPI接続をテストすること
5. 更新が保存されたとき、システムは変更成功を確認すること
6. 検証が失敗したとき、システムは具体的なエラーメッセージを提供すること

### 要件11: タスク分割と整理

**ユーザーストーリー:** 複雑なタスクや複数のタスクを一度に伝えるユーザーとして、システムに適切なサイズのタスクに分割してもらいたい。管理しやすく実行可能なタスクの集合にするため。

#### 受け入れ基準

1. ユーザーが複数のタスクを含む文章を提供したとき、システムは個別のタスクに分離すること
2. ユーザーが大きなタスクを提供したとき、システムは実行可能なサブタスクに分割すること
3. タスクを分割するとき、システムは各サブタスクが独立して実行可能であることを確認すること
4. タスクを分割するとき、システムは元のタスクの意図と目標を保持すること
5. 分割されたタスクには適切な順序や依存関係が設定されること
6. 分割結果をユーザーに提示するとき、システムは分割理由と推奨実行順序を説明すること

### 要件12: TODOリスト管理

**ユーザーストーリー:** 継続的にタスクを管理するユーザーとして、既存のTODOやタスクを一覧表示し、ステータスを更新したい。進行中の作業を効率的に追跡・管理できるようにするため。

#### 受け入れ基準

1. ユーザーがTODOリストを要求したとき、システムはすべての統合ソースからタスクを集約すること
2. Apple Remindersからタスクを取得するとき、システムは未完了のリマインダーを表示すること
3. Notionからタスクを取得するとき、システムは設定されたデータベースから未完了タスクを表示すること
4. タスクを表示するとき、システムは優先度、期限、ステータス、作成日を含めること
5. ユーザーがタスクのステータス更新を要求したとき、システムは該当するソース（Apple Reminders/Notion）で更新すること
6. タスクが完了としてマークされたとき、システムは統合されたすべてのソースで同期すること
7. フィルタリングが要求されたとき、システムは優先度、期限、ステータス別にタスクを絞り込むこと
8. 今日のタスクが要求されたとき、システムは本日期限または今日実行予定のタスクのみを表示すること

### 要件13: Remote MCP Server対応

**ユーザーストーリー:** iOS/iPadOSやWebブラウザからClaude.aiを使用するユーザーとして、デスクトップ版と同じ完全なsage機能にアクセスしたい。どのプラットフォームからでも一貫したタスク管理体験を得られるようにするため。

#### 受け入れ基準

1. Remote MCPサーバーが起動したとき、システムはHTTPS/WebSocket接続を受け入れること
2. Claude iOS/iPadOS/Webからの接続時、システムはOAuth認証を実行すること
3. 認証が成功したとき、システムはユーザー固有の設定とデータにアクセスを提供すること
4. Remote MCP経由でツールが呼び出されたとき、システムはLocal MCP版と同じ結果を返すこと
5. ユーザー設定が更新されたとき、システムはクラウドストレージに永続化すること
6. 複数デバイスから同時アクセスがあったとき、システムは設定の競合を適切に解決すること
7. レート制限に達したとき、システムは適切なエラーメッセージを返すこと
8. 外部API統合時、システムはWeb API経由で同等の機能を提供すること

### 要件14: CLIオプションとサーバーモード

**ユーザーストーリー:** sageを様々な環境で実行するユーザーとして、コマンドラインオプションで動作モードを切り替えたい。Local MCP（Stdio）とRemote MCP（HTTP）を柔軟に選択できるようにするため。

#### 受け入れ基準

1. `--remote`オプションが指定されたとき、システムはHTTPサーバーモードで起動すること
2. オプションなしで起動されたとき、システムはStdioトランスポート（Local MCP）モードで起動すること
3. `--config <path>`オプションが指定されたとき、システムは指定されたパスの設定ファイルを読み込むこと
4. `--port <number>`オプションが指定されたとき、システムは指定されたポートでHTTPサーバーを起動すること（デフォルト: 3000）
5. `--host <address>`オプションが指定されたとき、システムは指定されたアドレスでリッスンすること（デフォルト: 0.0.0.0）
6. 環境変数`SAGE_REMOTE_MODE=true`が設定されているとき、システムはHTTPサーバーモードで起動すること
7. 環境変数`SAGE_PORT`が設定されているとき、システムは指定されたポートを使用すること
8. 環境変数`SAGE_AUTH_SECRET`が設定されているとき、システムはJWT認証のシークレットキーとして使用すること
9. HTTPサーバーモードで起動後、システムは`/health`エンドポイントでヘルスチェックに応答すること
10. HTTPサーバーモードで起動後、システムは`/mcp`エンドポイントでMCPリクエストを受け付けること
