# 実装計画

> **TDD原則**: 各タスクは「テスト作成 → 実装 → リファクタリング」の順で進める
> **マルチプラットフォーム**: Desktop/Code (MCP)、iOS/iPadOS (Skills)、Web (Skills) 対応

- [x] 1. プロジェクト基盤とマルチプラットフォーム構造を構築
  - TypeScriptプロジェクトの初期化とMCP SDK + Skills対応
  - Jest設定とテスト環境のセットアップ
  - プラットフォーム検出とアダプター基盤の実装
  - _要件: 1.1, 1.2, 7.1, 7.2_

- [x] 2. プラットフォーム適応レイヤーの実装
- [x] 2.1 プラットフォーム検出機能を実装
  - **テスト**: `tests/unit/platform-detector.test.ts`を先に作成
  - MCP環境、iOS/iPadOS Skills、Web Skills環境の検出
  - プラットフォーム別機能可用性の判定
  - _要件: 7.1, 7.2, 7.3_

- [x] 2.2 プラットフォームアダプターファクトリーを実装
  - **テスト**: `tests/unit/platform-adapter.test.ts`を先に作成
  - MCPAdapter、SkillsAdapteriOS、SkillsAdapterWebの実装
  - 統一インターフェースでのプラットフォーム抽象化
  - _要件: 7.3, 7.4, 7.5_

- [x] 2.3 共通コアロジックの実装
  - **テスト**: `tests/unit/sage-core.test.ts`を先に作成
  - プラットフォーム非依存のタスク分析ロジック
  - 共通データモデルとインターフェース定義
  - _要件: 2.1, 2.2, 11.1_

- [x] 3. 設定管理システムの実装
- [x] 3.1 プラットフォーム適応型設定管理を実装
  - **テスト**: `tests/unit/config-loader.test.ts`を先に作成
  - Desktop: ~/.sage/config.json、iOS/iPadOS: セッション+iCloud、Web: セッションのみ
  - プラットフォーム別設定ストレージの抽象化
  - _要件: 1.1, 1.5, 10.1_

- [x] 3.2 設定値検証システムを実装
  - **テスト**: バリデーションのテストケースを先に作成
  - プラットフォーム固有設定項目の検証
  - 必須項目の存在確認とデフォルト値設定
  - _要件: 10.2, 10.3, 10.6_

- [ ] 3.3 設定同期機能を実装（iOS/iPadOS専用）
  - **テスト**: 設定同期のテストケースを先に作成
  - iCloud経由での設定同期機能
  - セッション設定の永続化オプション
  - _要件: 10.1, 10.5_

- [x] 4. セットアップウィザードの実装
- [x] 4.1 プラットフォーム適応型セットアップ状態確認を実装
  - **テスト**: `tests/unit/wizard.test.ts`を先に作成
  - check_setup_statusツール（MCP）/セットアップ状態確認（Skills）
  - プラットフォーム別設定完全性チェック
  - _要件: 1.1, 1.6_

- [x] 4.2 対話的セットアップウィザードを実装
  - **テスト**: ウィザードフローのテストケースを先に作成
  - プラットフォーム最適化された質問セット
  - MCP: start_setup_wizardツール、Skills: インタラクティブフロー
  - _要件: 1.3, 1.4_

- [x] 4.3 プラットフォーム固有質問の実装
  - **テスト**: プラットフォーム別質問のテストケースを先に作成
  - Desktop: AppleScript権限、Notion MCP設定
  - iOS/iPadOS: ネイティブ統合権限、iCloud同期設定
  - Web: 制限機能の説明と代替手段提案
  - _要件: 1.3, 1.4_

- [x] 4.4 設定保存機能を実装
  - プラットフォーム適応型設定保存
  - ウィザード完了時の適切なストレージへの保存
  - _要件: 1.4, 1.5, 1.6_

- [x] 5. タスク分割エンジンの実装
- [x] 5.1 複数タスク分離機能を実装
  - **テスト**: `tests/unit/task-splitter.test.ts`を先に作成
  - 一つの文章から複数のタスクを識別・分離
  - プラットフォーム非依存の共通ロジック
  - _要件: 11.1, 11.4_

- [x] 5.2 大きなタスクの分割機能を実装
  - **テスト**: 複雑タスク分割のテストケースを先に作成
  - 複雑なタスクのサブタスク分解
  - 実行可能な単位への分割ロジック
  - _要件: 11.2, 11.3_

- [x] 5.3 タスク依存関係と順序付けを実装
  - **テスト**: 依存関係検出のテストケースを先に作成
  - 分割されたタスク間の依存関係分析
  - 推奨実行順序の決定とユーザーへの説明
  - _要件: 11.5, 11.6_

- [x] 5. 優先度判定エンジンの実装
- [x] 5.1 基本優先度ルールエンジンを実装
  - **テスト**: `tests/unit/priority.test.ts`を先に作成
  - P0-P3の優先度判定ロジック
  - 設定ベースの条件評価システム
  - _要件: 2.1, 2.2, 2.5_

- [x] 5.2 期限ベース優先度判定を実装
  - **テスト**: 期限判定のテストケースを先に作成
  - 期限キーワードの検出と緊急度評価
  - 24時間、3日、1週間などの期限しきい値処理
  - _要件: 2.3_

- [x] 5.3 関係者ベース優先度判定を実装
  - **テスト**: 関係者判定のテストケースを先に作成
  - マネージャーや重要な関係者の検出
  - 関係者に基づく優先度調整
  - _要件: 2.4_

- [x] 6. 時間見積もりシステムの実装
- [x] 6.1 キーワードベース時間見積もりを実装
  - **テスト**: `tests/unit/estimation.test.ts`を先に作成
  - タスク内容からのキーワード抽出
  - 複雑度に基づく時間見積もりアルゴリズム
  - _要件: 3.1, 3.2, 2.6_

- [ ] 6.2 見積もり精度向上機能を実装
  - ユーザーフィードバックによる学習機能
  - 個人の作業パターンに基づく調整
  - _要件: 3.1, 3.2_

- [x] 7. 関係者抽出システムの実装
- [x] 7.1 基本関係者抽出機能を実装
  - **テスト**: `tests/unit/stakeholders.test.ts`を先に作成
  - タスク内容からの関係者名抽出
  - 設定されたチームメンバーとのマッチング
  - _要件: 4.1, 4.2_

- [x] 7.2 @メンション検出機能を実装
  - **テスト**: メンション検出のテストケースを先に作成
  - @記号付きメンションの検出と抽出
  - メンション形式の正規化処理
  - _要件: 4.3_

- [x] 7.3 マネージャー検出機能を実装
  - **テスト**: マネージャー検出のテストケースを先に作成
  - マネージャーキーワードの検出
  - マネージャー関与のフラグ付け
  - _要件: 4.4, 4.5_

- [x] 8. タスク分析統合システムの実装
- [x] 8.1 analyze_tasksツールを実装
  - **テスト**: `tests/unit/analyze-tasks.test.ts`を先に作成
  - 全分析機能を統合したメインツール
  - 優先度、時間、関係者の包括的分析
  - _要件: 2.1, 2.5, 2.6_

- [x] 8.2 分析結果フォーマット機能を実装
  - 分析結果の構造化と理由説明
  - ユーザーフレンドリーな結果表示
  - _要件: 2.5_

- [x] 9. Apple Reminders統合の実装
- [x] 9.1 プラットフォーム別Reminders統合基盤を実装
  - **テスト**: `tests/unit/apple-reminders.test.ts`を先に作成
  - iOS/iPadOS: ネイティブ統合、macOS: AppleScript、Web: 手動コピー推奨
  - プラットフォーム検出と適切な統合方法の選択
  - _要件: 9.2, 9.3_

- [x] 9.2 ネイティブReminders統合を実装（iOS/iPadOS Skills専用）
  - **テスト**: `tests/integration/native-reminders.test.ts`を先に作成（モック使用）
  - `window.claude?.reminders?.create()`を使用したネイティブ統合
  - 権限要求フローとエラーハンドリング
  - _要件: 9.2, 9.4, 9.5_

- [x] 9.3 AppleScript Reminders統合を実装（Desktop MCP専用）
  - **テスト**: `tests/integration/applescript-reminders.test.ts`を先に作成（モック使用）
  - node-applescriptを使用したApple Reminders連携
  - AppleScriptコマンドの実行とエラーハンドリング
  - _要件: 9.3, 9.4, 9.5_

- [x] 9.4 統合リマインダー作成機能を実装
  - **テスト**: 統合リマインダー作成のテストケースを先に作成
  - プラットフォーム適応型のリマインダー作成
  - 適切な期限日とアラーム設定
  - _要件: 9.1, 9.4, 9.5_

- [x] 9.5 Web版フォールバック機能を実装
  - **テスト**: フォールバック機能のテストケースを先に作成
  - 手動コピー用のフォーマット済みテキスト生成
  - Apple Remindersへの手動追加手順の提供
  - _要件: 9.6_

- [x] 10. Notion統合の実装
- [x] 10.1 Desktop/Code MCP版Notion統合を実装
  - **テスト**: `tests/unit/notion-mcp.test.ts`を先に作成（モック使用）
  - MCP経由でのNotion統合基盤
  - Notion MCPサーバーとの通信とエラーハンドリング
  - _要件: 8.2_

- [x] 10.2 iOS/iPadOS Skills版Notion Connector統合を実装
  - **テスト**: `tests/integration/notion-connector.test.ts`を先に作成（モック使用）
  - Claude Skills環境でのNotion Connector使用
  - `window.claude?.notion?.createPage()`等のネイティブ統合
  - _要件: 8.1, 8.2_

- [x] 10.3 プラットフォーム適応型Notionページ作成機能を実装
  - **テスト**: ページ作成のテストケースを先に作成
  - Desktop: MCP経由、iOS/iPadOS: Connector経由でのページ作成
  - 8日以上先のタスクのNotionページ作成
  - _要件: 8.1, 8.3_

- [x] 10.4 Web版Notionフォールバック機能を実装
  - **テスト**: フォールバック機能のテストケースを先に作成
  - Web版での手動Notion追加推奨
  - フォーマット済みNotionページテンプレートの生成
  - _要件: 8.4, 8.5_

- [x] 11. カレンダー統合の実装
- [x] 11.1 プラットフォーム別カレンダー統合基盤を実装
  - **テスト**: `tests/unit/calendar-service.test.ts`を先に作成
  - iOS/iPadOS: ネイティブ統合、macOS: AppleScript、Web: 手動入力
  - プラットフォーム検出と適切な統合方法の選択
  - _要件: 6.1, 6.9_

- [x] 11.2 ネイティブカレンダー統合を実装（iOS/iPadOS Skills専用）
  - **テスト**: `tests/integration/native-calendar.test.ts`を先に作成（モック使用）
  - `window.claude?.calendar?.getEvents()`を使用したネイティブ統合
  - EventKit経由でのカレンダーイベント取得
  - _要件: 6.2, 6.4_

- [x] 11.3 AppleScriptカレンダー統合を実装（Desktop MCP専用）
  - **テスト**: `tests/integration/applescript-calendar.test.ts`を先に作成（モック使用）
  - AppleScript経由でのCalendar.appからのイベント取得
  - macOS Calendar.appとの連携とエラーハンドリング
  - _要件: 6.3, 6.4_

- [x] 11.4 Web版カレンダーフォールバック機能を実装
  - **テスト**: フォールバック機能のテストケースを先に作成
  - 手動カレンダー入力フォームの提供
  - 基本的な空き時間推定機能
  - _要件: 6.9_

- [x] 11.5 空き時間検出機能を実装
  - **テスト**: 空き時間検出のテストケースを先に作成
  - プラットフォーム適応型のカレンダーイベント分析
  - 勤務時間内での利用可能時間枠検出
  - _要件: 6.4, 6.7_

- [x] 11.6 作業適合度評価機能を実装
  - **テスト**: 適合度評価のテストケースを先に作成
  - 深い作業日vs会議の多い日の考慮
  - 時間枠の適合度ランキングと統合方法の明記
  - _要件: 6.5, 6.6, 6.8_

- [x] 12. リマインド管理システムの実装
- [x] 12.1 リマインド振り分けロジックを実装
  - **テスト**: `tests/unit/reminder-manager.test.ts`を先に作成
  - 期限に基づくApple Reminders/Notion振り分け
  - 7日/8日しきい値での自動判定
  - _要件: 5.2, 5.3_

- [x] 12.2 set_reminderツールを実装
  - **テスト**: set_reminderのテストケースを先に作成
  - リマインド設定のメインツール
  - 適切なサービスへの自動振り分け
  - _要件: 5.1, 5.4, 5.5, 5.6_

- [x] 12.3 リマインド時間計算機能を実装
  - **テスト**: 時間計算のテストケースを先に作成
  - 設定に基づく適切なリマインド時間算出
  - 複数リマインドタイプの対応
  - _要件: 5.1, 5.4_

- [x] 13. sync_to_notionツールの実装
- [x] 13.1 Notion MCP同期メインツールを実装
  - **テスト**: sync_to_notionのテストケースを先に作成
  - 長期タスクのNotion MCP経由同期機能
  - タスク情報の適切なMCPツール呼び出し
  - _要件: 8.1, 8.2, 8.3_

- [x] 13.2 MCP通信エラーハンドリングを実装
  - **テスト**: エラーハンドリングのテストケースを先に作成
  - MCP接続エラーやツール実行エラーの処理
  - ユーザーフレンドリーなエラーメッセージ
  - _要件: 8.5_

- [x] 14. 設定更新システムの実装
- [x] 14.1 update_configツールを実装
  - 既存設定の部分更新機能
  - セクション別の設定変更対応
  - _要件: 10.1_

- [x] 14.2 設定検証機能を実装
  - 更新時の設定値検証
  - API接続テストと形式チェック
  - _要件: 10.2, 10.3, 10.4_

- [x] 14.3 設定変更確認機能を実装
  - 更新成功の確認メッセージ
  - 検証失敗時の具体的エラー表示
  - _要件: 10.5, 10.6_

- [x] 15. エラーハンドリングとロバストネスの実装
- [x] 15.1 統一エラーハンドリングシステムを実装
  - 全ツール共通のエラー処理機構
  - エラー分類と適切なメッセージ生成
  - _要件: 5.6, 8.5, 9.5_

- [x] 15.2 リトライ機構を実装
  - ネットワークエラーや一時的障害の自動リトライ
  - 指数バックオフによるリトライ間隔制御
  - _要件: 5.6, 8.5_

- [x] 15.3 グレースフルデグラデーション機能を実装
  - 一部機能失敗時の他機能継続動作
  - 代替手段の提案機能
  - _要件: 7.3, 7.4, 7.5_

- [x] 16. マルチプラットフォーム対応の実装
- [x] 16.1 Desktop/Code MCP版パッケージングを実装
  - MCPサーバー用のpackage.jsonとmanifest設定
  - 環境変数設定とエントリーポイント定義
  - _要件: 7.1, 7.4_

- [ ] 16.2 iOS/iPadOS Skills版パッケージングを実装
  - Claude Skills用のスクリプトとメタデータ
  - ネイティブ統合機能の適切な実装
  - _要件: 7.2, 7.4_

- [ ] 16.3 Web Skills版パッケージングを実装
  - 軽量版Skills実装とブラウザ互換性
  - 制限機能の適切な説明とフォールバック
  - _要件: 7.3, 7.4_

- [ ] 16.4 プラットフォーム間互換性テストを実装
  - 共通ロジックの全プラットフォーム動作確認
  - 設定データの互換性検証
  - _要件: 7.3, 7.4, 7.5_

- [x] 17. テストカバレッジ確認とE2Eテスト
  > **注**: ユニットテストと統合テストは各タスクでTDD方式で作成済み

- [x] 17.1 テストカバレッジ確認
  - 全テストの実行と結果確認
  - カバレッジレポート生成（目標: 80%以上）→ **94%達成**
  - 不足しているテストケースの追加
  - _要件: 全要件の検証_

- [ ] 17.2 E2Eテストを実装
  - **テスト**: `tests/e2e/full-workflow.test.ts`を作成
  - セットアップから分析、リマインド作成までの完全フロー
  - 実際のユーザーシナリオの検証
  - _要件: 1.1-1.6, 2.1-2.6, 5.1-5.6_

- [ ] 17.3 エッジケーステストの追加
  - 境界値テスト
  - エラー条件のテスト
  - 国際化（日本語/英語）のテスト
  - _要件: 全要件_

- [x] 18. ドキュメントとデプロイメント準備
- [x] 18.1 プラットフォーム別ユーザードキュメントを作成
  - README.mdとプラットフォーム別セットアップガイド
  - Desktop/Code MCP、iOS/iPadOS Skills、Web Skills版の使用例
  - _要件: 1.3, 1.6_

- [ ] 18.2 開発者ドキュメントを作成
  - マルチプラットフォームアーキテクチャの説明
  - プラットフォーム別拡張とカスタマイズガイド
  - _要件: 全要件の実装ガイド_

- [x] 18.3 配布パッケージを作成
  - MCP版、Skills版の各パッケージ生成
  - プラットフォーム別インストールテストと配布準備
  - _要件: 7.1, 7.2, 7.3_
