# 実装計画

> **TDD原則**: 各タスクは「テスト作成 → 実装 → リファクタリング」の順で進める

- [ ] 1. プロジェクト基盤とMCPサーバーの基本構造を構築
  - TypeScriptプロジェクトの初期化とMCP SDKの統合
  - Jest設定とテスト環境のセットアップ
  - 基本的なサーバー構造とツール登録システムの実装
  - _要件: 1.1, 1.2, 7.1, 7.2_

- [ ] 2. 設定管理システムの実装
- [ ] 2.1 設定ファイルの読み書き機能を実装
  - **テスト**: `tests/unit/config-loader.test.ts`を先に作成
  - ~/.sage/config.jsonの読み込み・保存機能
  - 設定ファイルの存在確認とバリデーション
  - _要件: 1.1, 1.5, 10.1_

- [ ] 2.2 設定値検証システムを実装
  - **テスト**: バリデーションのテストケースを先に作成
  - 設定項目の型チェックと形式検証
  - 必須項目の存在確認とデフォルト値設定
  - _要件: 10.2, 10.3, 10.6_

- [ ] 3. セットアップウィザードの実装
- [ ] 3.1 セットアップ状態確認機能を実装
  - **テスト**: `tests/unit/wizard.test.ts`を先に作成
  - check_setup_statusツールの実装
  - 設定ファイルの存在と完全性チェック
  - _要件: 1.1, 1.6_

- [ ] 3.2 対話的セットアップウィザードを実装
  - **テスト**: ウィザードフローのテストケースを先に作成
  - start_setup_wizardツールの実装
  - 10問の質問フローとセッション管理
  - _要件: 1.3, 1.4_

- [ ] 3.3 ウィザード質問応答システムを実装
  - **テスト**: 回答検証のテストケースを先に作成
  - answer_wizard_questionツールの実装
  - 回答の検証と次の質問への遷移ロジック
  - _要件: 1.3, 1.4_

- [ ] 3.4 設定保存機能を実装
  - save_configツールの実装
  - ウィザード完了時の設定ファイル生成
  - _要件: 1.4, 1.5, 1.6_

- [ ] 4. タスク分割エンジンの実装
- [ ] 4.1 複数タスク分離機能を実装
  - **テスト**: `tests/unit/task-splitter.test.ts`を先に作成
  - 一つの文章から複数のタスクを識別・分離
  - タスク境界の検出とタスクリスト生成
  - _要件: 11.1, 11.4_

- [ ] 4.2 大きなタスクの分割機能を実装
  - **テスト**: 複雑タスク分割のテストケースを先に作成
  - 複雑なタスクのサブタスク分解
  - 実行可能な単位への分割ロジック
  - _要件: 11.2, 11.3_

- [ ] 4.3 タスク依存関係と順序付けを実装
  - **テスト**: 依存関係検出のテストケースを先に作成
  - 分割されたタスク間の依存関係分析
  - 推奨実行順序の決定とユーザーへの説明
  - _要件: 11.5, 11.6_

- [ ] 5. 優先度判定エンジンの実装
- [ ] 5.1 基本優先度ルールエンジンを実装
  - **テスト**: `tests/unit/priority.test.ts`を先に作成
  - P0-P3の優先度判定ロジック
  - 設定ベースの条件評価システム
  - _要件: 2.1, 2.2, 2.5_

- [ ] 5.2 期限ベース優先度判定を実装
  - **テスト**: 期限判定のテストケースを先に作成
  - 期限キーワードの検出と緊急度評価
  - 24時間、3日、1週間などの期限しきい値処理
  - _要件: 2.3_

- [ ] 5.3 関係者ベース優先度判定を実装
  - **テスト**: 関係者判定のテストケースを先に作成
  - マネージャーや重要な関係者の検出
  - 関係者に基づく優先度調整
  - _要件: 2.4_

- [ ] 6. 時間見積もりシステムの実装
- [ ] 6.1 キーワードベース時間見積もりを実装
  - **テスト**: `tests/unit/estimation.test.ts`を先に作成
  - タスク内容からのキーワード抽出
  - 複雑度に基づく時間見積もりアルゴリズム
  - _要件: 3.1, 3.2, 2.6_

- [ ] 6.2 見積もり精度向上機能を実装
  - ユーザーフィードバックによる学習機能
  - 個人の作業パターンに基づく調整
  - _要件: 3.1, 3.2_

- [ ] 7. 関係者抽出システムの実装
- [ ] 7.1 基本関係者抽出機能を実装
  - **テスト**: `tests/unit/stakeholders.test.ts`を先に作成
  - タスク内容からの関係者名抽出
  - 設定されたチームメンバーとのマッチング
  - _要件: 4.1, 4.2_

- [ ] 7.2 @メンション検出機能を実装
  - **テスト**: メンション検出のテストケースを先に作成
  - @記号付きメンションの検出と抽出
  - メンション形式の正規化処理
  - _要件: 4.3_

- [ ] 7.3 マネージャー検出機能を実装
  - **テスト**: マネージャー検出のテストケースを先に作成
  - マネージャーキーワードの検出
  - マネージャー関与のフラグ付け
  - _要件: 4.4, 4.5_

- [ ] 8. タスク分析統合システムの実装
- [ ] 8.1 analyze_tasksツールを実装
  - **テスト**: `tests/unit/analyze-tasks.test.ts`を先に作成
  - 全分析機能を統合したメインツール
  - 優先度、時間、関係者の包括的分析
  - _要件: 2.1, 2.5, 2.6_

- [ ] 8.2 分析結果フォーマット機能を実装
  - 分析結果の構造化と理由説明
  - ユーザーフレンドリーな結果表示
  - _要件: 2.5_

- [ ] 9. Apple Reminders統合の実装
- [ ] 9.1 プラットフォーム検出機能を実装
  - **テスト**: `tests/unit/platform-detection.test.ts`を先に作成
  - iOS/iPadOS/macOS/webプラットフォームの検出
  - 各プラットフォームでの利用可能な統合方法の判定
  - _要件: 9.2, 9.3_

- [ ] 9.2 ネイティブ統合基盤を実装（iOS/iPadOS用）
  - **テスト**: `tests/integration/native-reminders.test.ts`を先に作成（モック使用）
  - Claude iOSアプリのネイティブReminders統合使用
  - ネイティブAPI経由でのリマインダー作成
  - _要件: 9.2, 9.4, 9.5_

- [ ] 9.3 AppleScript統合基盤を実装（macOS用）
  - **テスト**: `tests/integration/applescript-reminders.test.ts`を先に作成（モック使用）
  - node-applescriptを使用したApple Reminders連携
  - AppleScriptコマンドの実行とエラーハンドリング
  - _要件: 9.3, 9.4, 9.5_

- [ ] 9.4 統合リマインダー作成機能を実装
  - **テスト**: 統合リマインダー作成のテストケースを先に作成
  - プラットフォーム適応型のリマインダー作成
  - 適切な期限日とアラーム設定
  - _要件: 9.1, 9.4, 9.5_

- [ ] 9.5 リマインダーリスト管理を実装
  - **テスト**: リスト振り分けのテストケースを先に作成
  - 設定されたリマインダーリストへの振り分け
  - プラットフォーム別のリスト選択ロジック
  - _要件: 9.4, 9.6_

- [ ] 10. Notion MCP統合の実装
- [ ] 10.1 Notion MCP接続基盤を実装
  - **テスト**: `tests/integration/notion-mcp.test.ts`を先に作成（モック使用）
  - MCP経由でのNotion統合基盤
  - Notion MCPサーバーとの通信とエラーハンドリング
  - _要件: 8.2_

- [ ] 10.2 Notion MCP経由でのページ作成機能を実装
  - **テスト**: ページ作成のテストケースを先に作成
  - 8日以上先のタスクのNotionページ作成
  - MCP toolsを使用したタイトル、優先度、期限、関係者の設定
  - _要件: 8.1, 8.3_

- [ ] 10.3 Notion MCP同期結果処理を実装
  - **テスト**: 結果処理のテストケースを先に作成
  - 作成成功時のページURL返却
  - MCP通信失敗時のエラー詳細提供
  - _要件: 8.4, 8.5_

- [ ] 11. カレンダー統合の実装
- [ ] 11.1 カレンダープラットフォーム検出機能を実装
  - **テスト**: `tests/unit/calendar-platform-detection.test.ts`を先に作成
  - iOS/iPadOS/macOS/webプラットフォームでの利用可能なカレンダー統合方法の検出
  - 各プラットフォームでの推奨統合方法の判定
  - _要件: 6.1, 6.9_

- [ ] 11.2 ネイティブカレンダー統合を実装（iOS/iPadOS用）
  - **テスト**: `tests/integration/native-calendar.test.ts`を先に作成（モック使用）
  - Claude iOSアプリのネイティブCalendar統合使用
  - EventKit経由でのカレンダーイベント取得
  - _要件: 6.2, 6.4_

- [ ] 11.3 AppleScriptカレンダー統合を実装（macOS用）
  - **テスト**: `tests/integration/applescript-calendar.test.ts`を先に作成（モック使用）
  - AppleScript経由でのCalendar.appからのイベント取得
  - macOS Calendar.appとの連携とエラーハンドリング
  - _要件: 6.3, 6.4_

- [ ] 11.4 代替カレンダー統合を実装
  - **テスト**: 代替統合のテストケースを先に作成
  - iCal URL読み込み機能
  - 手動入力フォールバック機能
  - _要件: 6.9_

- [ ] 11.5 空き時間検出機能を実装
  - **テスト**: 空き時間検出のテストケースを先に作成
  - プラットフォーム適応型のカレンダーイベント分析
  - 勤務時間内での利用可能時間枠検出
  - _要件: 6.4, 6.7_

- [ ] 11.6 作業適合度評価機能を実装
  - **テスト**: 適合度評価のテストケースを先に作成
  - 深い作業日vs会議の多い日の考慮
  - 時間枠の適合度ランキングと統合方法の明記
  - _要件: 6.5, 6.6, 6.8_

- [ ] 11.7 find_available_slotsツールを実装
  - **テスト**: ツール統合テストを先に作成
  - プラットフォーム適応型カレンダー統合機能のメインツール
  - 推奨時間枠の提案と理由説明
  - _要件: 3.3, 3.4, 3.5, 3.6_

- [ ] 12. リマインド管理システムの実装
- [ ] 12.1 リマインド振り分けロジックを実装
  - **テスト**: `tests/unit/reminder-manager.test.ts`を先に作成
  - 期限に基づくApple Reminders/Notion振り分け
  - 7日/8日しきい値での自動判定
  - _要件: 5.2, 5.3_

- [ ] 12.2 set_reminderツールを実装
  - **テスト**: set_reminderのテストケースを先に作成
  - リマインド設定のメインツール
  - 適切なサービスへの自動振り分け
  - _要件: 5.1, 5.4, 5.5, 5.6_

- [ ] 12.3 リマインド時間計算機能を実装
  - **テスト**: 時間計算のテストケースを先に作成
  - 設定に基づく適切なリマインド時間算出
  - 複数リマインドタイプの対応
  - _要件: 5.1, 5.4_

- [ ] 13. sync_to_notionツールの実装
- [ ] 13.1 Notion MCP同期メインツールを実装
  - **テスト**: sync_to_notionのテストケースを先に作成
  - 長期タスクのNotion MCP経由同期機能
  - タスク情報の適切なMCPツール呼び出し
  - _要件: 8.1, 8.2, 8.3_

- [ ] 13.2 MCP通信エラーハンドリングを実装
  - **テスト**: エラーハンドリングのテストケースを先に作成
  - MCP接続エラーやツール実行エラーの処理
  - ユーザーフレンドリーなエラーメッセージ
  - _要件: 8.5_

- [ ] 14. 設定更新システムの実装
- [ ] 14.1 update_configツールを実装
  - 既存設定の部分更新機能
  - セクション別の設定変更対応
  - _要件: 10.1_

- [ ] 14.2 設定検証機能を実装
  - 更新時の設定値検証
  - API接続テストと形式チェック
  - _要件: 10.2, 10.3, 10.4_

- [ ] 14.3 設定変更確認機能を実装
  - 更新成功の確認メッセージ
  - 検証失敗時の具体的エラー表示
  - _要件: 10.5, 10.6_

- [ ] 15. エラーハンドリングとロバストネスの実装
- [ ] 15.1 統一エラーハンドリングシステムを実装
  - 全ツール共通のエラー処理機構
  - エラー分類と適切なメッセージ生成
  - _要件: 5.6, 8.5, 9.5_

- [ ] 15.2 リトライ機構を実装
  - ネットワークエラーや一時的障害の自動リトライ
  - 指数バックオフによるリトライ間隔制御
  - _要件: 5.6, 8.5_

- [ ] 15.3 グレースフルデグラデーション機能を実装
  - 一部機能失敗時の他機能継続動作
  - 代替手段の提案機能
  - _要件: 7.3, 7.4, 7.5_

- [ ] 16. クロスプラットフォーム対応の実装
- [ ] 16.1 Claude Desktop用manifest.jsonを作成
  - MCPBパッケージング用のマニフェスト
  - 環境変数設定とエントリーポイント定義
  - _要件: 7.1, 7.4_

- [ ] 16.2 Claude Code用marketplace.jsonを作成
  - プラグインマーケットプレイス用設定
  - 同一機能の両プラットフォーム提供
  - _要件: 7.2, 7.4_

- [ ] 16.3 両プラットフォーム互換性テストを実装
  - Desktop/Code両環境での動作確認
  - 同一設定ファイル使用の検証
  - _要件: 7.3, 7.4, 7.5_

- [ ] 17. テストカバレッジ確認とE2Eテスト
  > **注**: ユニットテストと統合テストは各タスクでTDD方式で作成済み

- [ ] 17.1 テストカバレッジ確認
  - 全テストの実行と結果確認
  - カバレッジレポート生成（目標: 80%以上）
  - 不足しているテストケースの追加
  - _要件: 全要件の検証_

- [ ] 17.2 E2Eテストを実装
  - **テスト**: `tests/e2e/full-workflow.test.ts`を作成
  - セットアップから分析、リマインド作成までの完全フロー
  - 実際のユーザーシナリオの検証
  - _要件: 1.1-1.6, 2.1-2.6, 5.1-5.6_

- [ ] 17.3 エッジケーステストの追加
  - 境界値テスト
  - エラー条件のテスト
  - 国際化（日本語/英語）のテスト
  - _要件: 全要件_

- [ ] 18. ドキュメントとデプロイメント準備
- [ ] 18.1 ユーザードキュメントを作成
  - README.mdとセットアップガイド
  - 機能説明と使用例
  - _要件: 1.3, 1.6_

- [ ] 18.2 開発者ドキュメントを作成
  - API仕様とアーキテクチャ説明
  - 拡張とカスタマイズガイド
  - _要件: 全要件の実装ガイド_

- [ ] 18.3 配布パッケージを作成
  - MCPBファイルとプラグインパッケージの生成
  - インストールテストと配布準備
  - _要件: 7.1, 7.2_